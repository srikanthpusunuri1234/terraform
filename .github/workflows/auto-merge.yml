name: Auto PR (create-or-update) + Notify + Auto Merge on Approved

# Give Actions permission to read/write contents and PRs
permissions:
  contents: write
  pull-requests: write

on:
  push:
    branches:
      - frontend-final
      - backend-dev
  pull_request:
    types:
      - labeled

jobs:
  create-or-find-pr-and-notify:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get latest commit info
        id: commit
        run: |
          echo "msg=$(git log -1 --pretty=%s)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Check for an open PR from this branch â†’ master
        id: prcheck
        uses: actions/github-script@v6
        with:
          script: |
            // returns { pr_number, pr_url }
            const ref = context.ref.replace('refs/heads/','');
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const base = 'master'; // CHANGE THIS if your base branch is 'main' or 'Viaridez-UAT'
            const res = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              head: `${owner}:${ref}`,
              base
            });
            if (res.data.length > 0) {
              return { pr_number: res.data[0].number, pr_url: res.data[0].html_url };
            } else {
              return { pr_number: 0, pr_url: '' };
            }

      - name: Create Pull Request (only if none exists)
        id: create
        if: ${{ fromJson(steps.prcheck.outputs.result).pr_number == 0 }}
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Auto PR for ${{ github.ref_name }}"
          title: "Merge ${{ github.ref_name }} into master"
          body: |
            Auto-generated PR for branch: **${{ github.ref_name }}**

            **Latest Commit:** ${{ steps.commit.outputs.msg }}
            **Author:** ${{ steps.commit.outputs.author }}
          base: master   # CHANGE THIS if your base branch is 'main' or another name
          head: ${{ github.ref_name }}
          update-existing: false

      - name: Send email (existing PR link)
        if: ${{ fromJson(steps.prcheck.outputs.result).pr_number != 0 }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Approval Needed: Merge into master (existing PR)"
          to: srikanthpusunuri1165@gmail.com, srikanthp2425@gmail.com
          from: "GitHub Actions <${{ secrets.EMAIL_USERNAME }}>"
          body: |
            Hello Reviewer,

            A push was made to branch: **${{ github.ref_name }}**

            **Commit Message:** ${{ steps.commit.outputs.msg }}
            **Author:** ${{ steps.commit.outputs.author }}
            **Commit Link:** https://github.com/${{ github.repository }}/commit/${{ steps.commit.outputs.sha }}

            **Open PR:** ${{ fromJson(steps.prcheck.outputs.result).pr_url }}

            Please review and approve the merge into master.

      - name: Send email (newly created PR link)
        if: ${{ fromJson(steps.prcheck.outputs.result).pr_number == 0 }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Approval Needed: Merge into master (new PR created)"
          to: srikanthpusunuri1165@gmail.com, srikanthp2425@gmail.com
          from: "GitHub Actions <${{ secrets.EMAIL_USERNAME }}>"
          body: |
            Hello Reviewer,

            A push was made to branch: **${{ github.ref_name }}**

            **Commit Message:** ${{ steps.commit.outputs.msg }}
            **Author:** ${{ steps.commit.outputs.author }}
            **Commit Link:** https://github.com/${{ github.repository }}/commit/${{ steps.commit.outputs.sha }}

            **New PR:** ${{ steps.create.outputs.pull-request-url }}

            Please review and approve the merge into master.

  auto-merge-on-approved:
    if: github.event_name == 'pull_request' && github.event.label && github.event.label.name == 'approved'
    runs-on: ubuntu-latest
    needs: create-or-find-pr-and-notify
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Merge PR branch into master
        run: |
          # GITHUB_HEAD_REF is set for PR events in workflows
          PR_BRANCH=${GITHUB_HEAD_REF}
          echo "Merging branch: $PR_BRANCH"
          git fetch origin
          git checkout master
          git pull origin master
          git merge --no-ff origin/$PR_BRANCH -m "Auto-merge $PR_BRANCH into master"
          git push origin master
